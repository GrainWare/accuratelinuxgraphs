---
import { authors, descriptions } from "../ts/vars";
import Markov from "../ts/markov";
import graphsData from "../data/graphs.json";

const graphCaptions = graphsData.map((g) => g.caption);
const trainingData = [...graphCaptions, ...descriptions, ...authors];
const markov = new Markov();
await markov.load(trainingData);
const markovText = markov.generate(10);

// math equation to generate the accurate number of the day
const x = new Date().getDate();
const y = new Date().getSeconds();
const z = new Date().getMilliseconds();
const accurateNumberStage1 = (x * y) / z;
const accurateNumberStage2 =
  accurateNumberStage1 % 1.785298349182997561289487198679829683916825689;
const accurateNumberStage3 = accurateNumberStage2 / 1000000000000000000;
let accuracyPercentage =
  1.128943789237891598723789147928789152897267891237086812735653 *
    100.5782384172874 +
  Math.sin(accurateNumberStage2) * 10008.5782384172874;

if (Math.random() < 0.1) {
  accuracyPercentage += 500000;
}

let accuracyStyle = `color: hsl(${accuracyPercentage}, 100%, 50%); font-weight: bold;`;
---

<script>
  const button = document.getElementById("accuRotateBtn");
  const audio: HTMLAudioElement | null = document.getElementById(
    "accuRotateAudio",
  ) as HTMLAudioElement;
  const credits = document.getElementById("credits");

  if (button) {
    button.textContent = "enable ACCUROTATE 2.0 technology";
    button.removeAttribute("disabled");

    button.addEventListener("click", () => {
      const isEnabled = document.body.classList.contains("animate-rotate3d");

      if (isEnabled) {
        // Disable the accurotate technology
        document.body.classList.remove("animate-rotate3d");
        document.body.classList.add("animate-move");
        button.textContent = "enable ACCUROTATE 2.0 technology";

        if (audio) {
          audio.pause();
          audio.currentTime = 0;
        }

        if (credits) {
          credits.classList.add("invisible");
          credits.classList.remove("animate-vibrate2x");
        }
      } else {
        // Enable the accurotate technology
        document.body.style.cursor =
          "url('/assets/svg/middlefinger.svg'), auto";
        document.body.classList.remove("animate-move");
        document.body.classList.add("animate-rotate3d");

        if (audio) {
          audio.play();
        }

        if (credits) {
          credits.classList.remove("invisible");
          credits.classList.add("animate-vibrate2x");
        }
      }
    });
  } else {
    console.error('Button with id "accuRotateBtn" not found');
  }
</script>

<script is:inline>
  window.requestAnimFrame = (function () {
    return (
      window.requestAnimationFrame ||
      window.webkitRequestAnimationFrame ||
      window.mozRequestAnimationFrame ||
      window.ieRequestAnimationFrame ||
      function (callback) {
        window.setTimeout(callback, 1000 / 60);
      }
    );
  })();

  document.addEventListener("DOMContentLoaded", () => {
    const fpsElement = document.getElementById("fps");
    if (!fpsElement) {
      console.warn('Element with id "fps" not found');
      return;
    }

    let then = Date.now() / 1000;

    function render() {
      const now = Date.now() / 1000;
      const elapsedTime = Math.max(now - then, 0.000001);
      then = now;

      const fps = 1 / elapsedTime;
      fpsElement.textContent = "FPS: " + fps.toFixed(2);

      requestAnimFrame(render);
    }

    render();
  });
</script>

<script is:inline>
  // if toggleNewAccuracySong cookie is true replace the source with /assets/audio/accuracycore-audiowarning.mp3
  document.addEventListener("DOMContentLoaded", () => {
    const getCookieValue = (name) => {
      const match = document.cookie
        .split("; ")
        .find((row) => row.startsWith(`${name}=`));
      return match ? match.split("=")[1] : null;
    };

    const songElement = document.getElementById("song");
    if (songElement) {
      const toggleNewAccuracySong = getCookieValue("toggleNewAccuracySong");
      if (toggleNewAccuracySong === "true") {
        songElement.setAttribute(
          "src",
          "/assets/audio/accuracycore-audiowarning.mp3",
        );
        songElement.setAttribute("type", "audio/mpeg");
        // Reload the audio element to pick up the new source
        const audioElement = songElement.closest("audio");
        if (audioElement) {
          audioElement.load();
        }
      }
    }
  });
</script>

<header class="text-center text-white py-8">
  <h1 class="text-3xl font-bold text-grain-text">
    <a href="/fizzbuzz" class="hover:underline hover:animate-vibrate2x"
      >accuratelinuxgraphs.com</a
    >
    <p class="hover:animate-vibrate2x">{markovText}</p>
    <h2 class="text-4xl font-bold mb-2 animate-rainbow text-red-300" id="fps">
    </h2>
  </h1>

  <p class="text-lg mt-2 animate-bounce">
    YOUR source for the most ACCURATE linux graphs around.<br />
    <a
      href="https://grainware.org/"
      class="text-grain-highlight underline hover:text-2xl font-bold"
      >Made Possible by GrainWare</a
    >
  </p>

  <div class="flex flex-col items-center lg:flex-row justify-center">
    <a href="/graph"
      ><img
        id="site-icon"
        src="/assets/ico/grain.png"
        alt="Site Icon"
        title="a project of the grain"
        class="w-64 h-16"
      /></a
    >
    <p
      class="text-sm text-gray-400 transform-[scaleZ(4)] animate-vibrate lg:animate-none lg:transform-[scaleY(4)]"
    >
      Accurate Number: <span
        id="accurate-number"
        class="font-bold text-yellow-300">{accurateNumberStage3}</span
      ><br />
      Accuracy Percentage: <span
        id="accuracy-percentage"
        style={accuracyStyle}
        class="font-bold text-yellow-300">{accuracyPercentage}%</span
      >
    </p>

    <button
      id="accuRotateBtn"
      class="mt-4 bg-grain-bg border-grain-border border-8 hover:bg-red-900"
      disabled
    >
      enable js you idiot
    </button>

    <audio
      controls
      autoplay
      loop
      class="mt-4 mx-auto block hover:animate-vibrate"
    >
      <source
        id="song"
        src="/assets/audio/free-software-song.ogg"
        type="audio/ogg"
      />
      Your browser does not support the audio element. Seek help.
    </audio>

    <a href="https://store.accuratelinuxgraphs.com"
      ><img
        src="/assets/img/ad.avif"
        alt="Ad"
        class="w-64 h-16 mt-4 mx-auto"
        title="Ad"
      /></a
    >

    <a href="https://stats.atl.dev"
      ><img
        src="/assets/img/ad2.avif"
        alt="Ad"
        class="w-64 h-16 mt-4 mx-auto"
        title="Ad"
      /></a
    >

    <a href="https://accuracyrecords.bandcamp.com/"
      ><img
        src="/assets/img/ad3.avif"
        alt="Ad"
        class="w-64 h-16 mt-4 mx-auto"
        title="Ad"
      /></a
    >

    <audio loop id="accuRotateAudio" class="hidden">
      <source
        src="/assets/audio/extremebinarydrumandbass.mp3"
        type="audio/mp3"
        id="accuRotateAudio2"
      />
      Your browser does not support the audio element. Seek help.
    </audio>
    <p class="invisible" id="credits">
      AccuRotate Audio Credit: <a
        href="https://opengameart.org/content/extreme-binary-dnb"
        >Gobusto - Extreme Binary DnB</a
      >
    </p>
    <hr class="animate-ping" />
  </div>

  <a
    href="/trailer"
    class="mt-4 bg-grain-bg border-grain-border border-8 hover:bg-red-900 text-3xl"
  >
    Accuracy Trailer
  </a>
</header>
